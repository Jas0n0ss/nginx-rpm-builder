name: Build Nginx Variants RPM (RHEL9)

on:
  # schedule:
  #   - cron: '0 4 * * 0'   # 每周日凌晨 4:00 UTC（已注释）

  push:
    branches:
      - main  # 当 push 到 main 分支时触发

  workflow_dispatch:  # 仍保留手动触发
    inputs:
      target:
        description: 'Select build target'
        required: true
        type: choice
        options:
          - nginx-1.25.0
          - nginx-latest
          - tengine-latest
          - openresty-latest

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: quay.io/centos/centos:stream9

    env:
      BUILD_USER: builder
      BUILD_HOME: /home/builder
      RPMBUILD: /home/builder/rpmbuild

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Copy Project Files
        run: |
          cp -r $GITHUB_WORKSPACE/* /home/builder/ || true
          chown -R builder:builder /home/builder/

      - name: Copy Project Files
        run: |
          cd $GITHUB_WORKSPACE
          sudo chown -R builder .
          cp -r ./* /home/builder/

      - name: Setup Build Environment
        run: |
          su - builder -c "cd /home/builder && ./build/scripts/setup_env.sh"

      - name: Parse Build Target
        run: |
          # 默认为 nginx-latest，兼容 push 触发
          case "${{ github.event_name }}" in
            push)
              echo "BUILD_TARGET=nginx-latest" >> $GITHUB_ENV
              echo "Triggered by push, using default target: nginx-latest"
              ;;
            workflow_dispatch)
              case "${{ inputs.target }}" in
                nginx-1.25.0)
                  echo "BUILD_TARGET=nginx-1.25.0" >> $GITHUB_ENV
                  ;;
                nginx-latest)
                  echo "BUILD_TARGET=nginx-latest" >> $GITHUB_ENV
                  ;;
                tengine-latest)
                  echo "BUILD_TARGET=tengine-latest" >> $GITHUB_ENV
                  ;;
                openresty-latest)
                  echo "BUILD_TARGET=openresty-latest" >> $GITHUB_ENV
                  ;;
              esac
              ;;
          esac

      - name: Build RPM
        run: |
          su - builder -c "cd /home/builder && ./build/scripts/build.sh"
        env:
          BUILD_TARGET: ${{ env.BUILD_TARGET }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpms-${{ env.BUILD_TARGET }}
          path: /home/builder/rpmbuild/RPMS/x86_64/*.rpm
          if-no-files-found: warn

      - name: Extract Version from SPEC
        if: github.event_name == 'workflow_dispatch'
        run: |
          SPEC_FILE=$(find /home/builder/rpmbuild/SPECS -name "*.spec" | head -1)
          if [[ -f "$SPEC_FILE" ]]; then
            VERSION=$(grep "^Version:" "$SPEC_FILE" | awk '{print $2}')
            echo "RPM_VERSION=$VERSION" >> $GITHUB_ENV
            echo "✅ Detected version: $VERSION"
          else
            echo "❌ SPEC file not found"
            exit 1
          fi

      - name: Create GitHub Release (Manual Only)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.BUILD_TARGET }}-v${{ env.RPM_VERSION }}
          name: Release ${{ env.BUILD_TARGET }} ${{ env.RPM_VERSION }}
          files: /home/builder/rpmbuild/RPMS/x86_64/*.rpm
          generate_release_notes: true
